---
title: zookeeper学习笔记（1）2PC和3PC
date: 2018-01-18 11:02:33
tags: zookeeper学习笔记
categories: 技术
---
<img src="zookeeper学习笔记（1）2PC和3PC/书.PNG" width="60%">
<!--more-->
# 分布式系统的挑战

## 事务ACID
 - 原子性
 - 一致性
 - 隔离性
    - 未授权读取，允许脏读
    - 授权读取，允许不可重复读
    - 可重复读取，允许幻读
    - 串行化
- 持久性

## CAP理论
分布式系统不可能同时满足C（一致性），A（可用性），P（分区容错性）

## BASE理论
对CAP中一致性和可用性权衡的结果，无法做到强一致性

- Basically Avalible，基本可用
- Soft State，软状态
    相对于硬状态，存在中间状态
- Eventually consistent，最终一致性

# 一致性协议
## 2PC与3PC
角色：参与者，协调者
### **2PC**
- 阶段一 提交事务请求（也称为投票阶段）
    - **事务询问**
        协调者向参与者发送事务内容，询问是否可以执行事务，等待响应
    - **执行事务**
        执行事务，记录undo和redo信息到事务日志中
    - **参与者向协调者反馈事务询问的相应**
        - 如果成功执行事务，反馈yes
        - 如果执行失败，反馈no
- 阶段二 执行事务请求
    包含两种可能：
    - 得到的反馈都是yes，则**执行事务提交**：
        - **发送提交请求**：协调者向所有参与者发送commit请求
        - **事务提交**：参与者收到commit请求，执行commit操作
        - **反馈commit结果**：完成事务提交之后，向协调者发送ack消息
        - **完成事务**：协调者收到所有参与则的ack后，完成事务
    - 任意一个参与者反馈了no，或者协调者等待反馈超时，那么就**中断事务**：
        - 向所有参与者**发送rollback回滚请求**
        - 参与者收到**rollback请求**，根据undo信息回滚
        - **反馈回滚结果**：参与者回滚之后，向协调者发送ack消息
        - 协调者收到所有参与者反馈的ack消息后，完成**事务中断**


#### 优点
简单，实现方便
#### 缺点
- 同步阻塞
    二阶段执行阶段，所有参与者都处于阻塞阶段，等待其他参与者的响应（阶段一）
- 单点问题
    协调者
- 脑裂，数据不一致
    阶段二协调者崩溃，导致只有部分参与者收到commit请求，数据不一致
- 太过保守
    参与者发生故障，协调者只能通过超时机制感知


### **3PC**
阶段一：**CanCommit**
- **事务询问**：协调者向参与者发送CanCommit请求
- **反馈yes或者no**：参与者向协调反馈是否可以执行事务

阶段二：**PreCommit**
包含两种可能：
- **执行事务提交**，参与者反馈的都是yes
    - **发送预提交请求**
        - 协调者向所有参与者发出preCommit请求，进入Prepared阶段
    - **事务预提交**
        - 参与者接收到preCommit请求，执行事务操作，记录undo和redo信息到事务日志
    - **参与者反馈事务执行的响应**
        - 如果参与者成功执行了操作，向协调者发送ack响应，同时等待协调者的最终指令：commit或者abort
- **中断事务**，任意参与者反馈了no，或者等待超时
    - **发送中断请求**
        - 协调者发送abort请求
    - **中断事务**
        - 收到协调者的abort请求，或者等待协调者请求超时，参与者中断事务

阶段三：**DoCommit**
也包含两种可能：
- **执行提交**
    - **发送提交请求**
        - 协调者收到所有参与者的ack，从“预提交”状态转换到“提交”状态，向参与者发送doCommit请求
    - **事务提交**
        - 参与者收到doCommit请求，执行事务提交操作
    - **反馈事务提交结果**
        - 参与者向协调者发送ack消息
    - **完成事务**
        - 协调者收到所有的ack，完成事务
- **中断事务**，任意一个参与者反聩了no，或者协调者接收反馈超时
    - **发送中断请求**
        - 协调者发送abort请求
    - **事务回滚**
        - 参与者收到abort请求后，根据undo信息回滚
    - **反馈回滚结果**
        - 参与者回滚后，发送ack消息
    - **中断事务**
        - 协调者收到所有ack后，中断事务

**注意**：进入阶段三，协调者crash或者网络出现故障，参与者无法收到协调者的abort或者doCommit请求，会在等待超时后进行事务提交（这点在2PC协议中，参与者会一直阻塞下去）

#### 优点
降低了2PC参与者的阻塞范围

#### 缺点
**参与者收到preCommit后，如果协调者crash或者网络出现分区，此时协调者和参与者无法通信，此时参与者仍然将提交事务，会导致不一致性**

